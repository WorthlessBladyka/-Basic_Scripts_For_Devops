# Commands
`$sudo iptables -L -nv` - просмотр текущих правил.
`$sudo iptables -t nat -L -nv` - просмотр текущих правил table nat.

Флаги:
- -A - в добавить правило в конец списка
- -I - в добавить правило в начало списка
- -j - действие DROP, ACCEPT и др.
- -s 11.111.11.111 - указать ip
- -p TCP - указать protocol
- -i enp0s3 - указать интерфейс
- --dport 22 - указать порт
## NFQUEUE
`sudo iptables -t mangle -A PREROUTING -p tcp --dport 443 -j NFQUEUE --queue-num 0`
`sudo iptables -t mangle -A OUTPUT -p tcp --dport 443 -j NFQUEUE --queue-num 0`
[Теория](#NFQUEUE_теория)
## Save_settings
`sudo apt-get install iptables-persistent`
`sudo iptables-save > /etc/iptables/rules.v4`
`sudo iptables-restore < /etc/iptables/rules.v4`

`netfilter-persistent save` - save roles
`netfilter-persistent start` - start roles

>Правила сохраняются в `/etc/iptables/rules.v4`(для IPv4) и `/etc/iptables/rules.v6`(для IPv6).
## Packets
- iptables-persistent
- netfilter-persistent
# Теория
![[2608017e6b7d35b36aa066de1f411f74.jpg]]
  
***Iptables*** - позволяет администраторам управлять входящими и исходящими пакетами данных. Это основной инструмент для настройки межсетевых экранов в системах Linux.
Iptables работает путем проверки пакетов данных на соответствие определенным критериям и выполнения заданных действий, если пакеты соответствуют этим критериям. Эти критерии и действия определяются в таблицах, которые состоят из набора правил.

В Iptables есть четыре основные таблицы:
1. **Filter** - это основная таблица, используемая для фильтрации пакетов.
2. **NAT** - эта таблица используется для настройки NAT (Network Address Translation).
3. **Mangle** - эта таблица используется для специальной обработки пакетов.
4. **Raw** - эта таблица используется для обхода системы отслеживания состояний.

Каждая таблица состоит из набора цепочек. 
***Цепочки*** - это последовательности правил, которые применяются к пакетам. В Iptables есть три встроенные цепочки.
1. **INPUT** - эта цепочка применяется к пакетам, которые предназначены для самой системы.
2. **FORWARD** - эта цепочка применяется к пакетам, которые проходят через систему.
3. **OUTPUT** - эта цепочка применяется к пакетам, которые исходят из системы.

###### Действия для закрытия трафика:
- **Reject**
- **Drop**
###### NFQUEUE_теория
***NFQUEUE*** - отправляет пакеты в программу пользовательского пространства для обработки и принятия решений. Это позволяет пользовательским приложениям, анализировать, изменять или отбрасывать пакеты. 

iptables создается правило с указанием цели `-j NFQUEUE` для перехвата определенного сетевого трафика. Когда пакет соответствует правилу, ядро ​​Linux помещает его в определенную очередь, заданную параметром `--queue-num`. Далее отдельная программа пользовательского пространства, подключается к этой очереди через сокет Netlink для получения пакетов и их метаданных. Затем программа пользовательского пространства выдает вердикт для каждого пакета, который может быть следующим:
- **NF_ACCEPT** Пакет принят и проходит обычную обработку в Netfilter.
- **NF_DROP** Пакет полностью отбрасывается.
- **NF_REPEAT** Пакет повторно помещается в очередь.
- **NF_STOP** Обработка пакетов прекращается.
- **NF_QUEUE** Пакет отправляется в другую очередь.
Для перенаправления всего трафика в диапазон очередей (от 0 до 3) с использованием балансировки нагрузки между потоками:
`sudo iptables -A FORWARD -j NFQUEUE --queue-balance 0:3`
# Other
[Sockets](Сокеты.md)
[ip a](Network_command)
# Link resources
[Подробнее](https://web.archive.org/web/20180305073753/https://www.iptables.info/en/structure-of-iptables.html#MANGLETABLE)
[Введение](https://habr.com/ru/articles/747616/)